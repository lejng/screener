<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Spreads Table</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
    }

    .spinner-border {
      width: 4rem;
      height: 4rem;
    }

    .table-container {
      display: none;
      /* hidden until data loads */
      margin-top: 30px;
    }
  </style>
</head>

<body class="text-center p-4">
  <div class="container">
    <h1 class="mb-4">ðŸ“Š All spreads</h1>

    <!-- Filter Form -->
    <form id="filter-form" class="card p-3 shadow-sm mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-md-2">
          <label for="minSpread" class="form-label">Min Spread %</label>
          <input type="number" class="form-control" id="minSpread" placeholder="1" value="1" />
        </div>
        <div class="col-md-2">
          <label for="maxSpread" class="form-label">Max Spread %</label>
          <input type="number" class="form-control" id="maxSpread" placeholder="100" value="100" />
        </div>
        <div class="col-md-2" hidden>
          <label for="amountInUsdt" class="form-label">Maximum trading amount (USDT)</label>
          <input type="number" class="form-control" id="amountInUsdt" placeholder="100" value="100" />
        </div>
      </div>

      <div class="row g-3 align-items-end">
        <div class="col-md-6">
          <label for="exchanges_spot" class="form-label">Exchanges spot</label>
          <select id="exchanges_spot" class="form-select" multiple style="height: 200px;">
            <option selected>BYBIT</option>
            <option selected>KUCOIN</option>
            <option selected>GATEIO</option>
            <option selected>MEXC</option>
            <option>BITGET</option>
            <option>BINANCE</option>
            <option>OKX</option>
          </select>
          <small class="text-muted">Hold Ctrl (Cmd on Mac) to select multiple</small>
        </div>
      </div>
      <div class="row g-3 align-items-end">
        <div class="col-md-6">
          <label for="exchanges_swap" class="form-label">Exchanges swap</label>
          <select id="exchanges_swap" class="form-select" multiple style="height: 300px;">
            <option selected>BYBIT</option>
            <option selected>KUCOIN</option>
            <option selected>GATEIO</option>
            <option selected>MEXC</option>
            <option selected>HYPERLIQUID</option>
            <option selected>PARADEX</option>
            <option>BITGET</option>
            <option>BINANCE</option>
            <option>OKX</option>
          </select>
          <small class="text-muted">Hold Ctrl (Cmd on Mac) to select multiple</small>
        </div>
      </div>
      <div class="row g-3 align-items-end">
        <div class="col-md-6">
          <label for="exchanges_future" class="form-label">Exchanges future</label>
          <select id="exchanges_future" class="form-select" multiple style="height: 100px;">
            <option>BYBIT</option>
            <option>GATEIO</option>
          </select>
          <small class="text-muted">Hold Ctrl (Cmd on Mac) to select multiple</small>
        </div>
      </div>
      <div class="row g-3 align-items-center">
        <div class="col-md-2 d-flex align-items-center">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="noTransfer" checked>
            <label class="form-check-label" for="noTransfer">
              ðŸš« Search Spreads Without Transfer
            </label>
          </div>
        </div>
        <div class="row g-3 align-items-end">
          <div class="col-md-2 text-end">
            <button type="button" class="btn btn-primary w-100" onclick="fetchSpreads()">
              ðŸ”„ Load/Update
            </button>
          </div>
        </div>
      </div>

    </form>

    <!-- Spinner -->
    <div class="d-flex justify-content-center mt-5">
      <div id="spinner" class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Table -->
    <div id="table-container" class="table-container">
      <table id="spreads-table" class="table table-striped table-hover align-middle shadow-sm">
        <thead class="table-light">
          <tr>
            <th scope="col">Coin</th>
            <th scope="col">Spread %</th>
            <th scope="col">Buy</th>
            <th scope="col">Sell</th>
            <th scope="col">More info</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    setLoadingState(false);

    function getSelectedValues(selectId) {
      const element = document.getElementById(selectId);
      if (!element) return [];
      return Array.from(element.selectedOptions).map((opt) => opt.value);
    }

    function setLoadingState(isLoading, options = {}) {
      const { spinnerId = 'spinner', buttonId } = options;
      const spinner = document.getElementById(spinnerId);
      const button = buttonId ? document.getElementById(buttonId) : null;
      if (spinner) spinner.style.display = isLoading ? 'flex' : 'none';
      if (button) button.disabled = isLoading;
    }

    function getFilters() {
      return {
        minSpread: parseFloat(document.getElementById("minSpread").value),
        maxSpread: parseFloat(document.getElementById("maxSpread").value),
        amountInUsdt: parseFloat(document.getElementById("amountInUsdt").value),
        spot: getSelectedValues("exchanges_spot"),
        swap: getSelectedValues("exchanges_swap"),
        future: getSelectedValues("exchanges_future"),
        noTransfer: document.getElementById("noTransfer").checked,
      };
    }

    function buildRequestBody(filters) {
      return {
        min_spread: filters.minSpread,
        max_spread: filters.maxSpread,
        spot_exchanges: filters.spot,
        swap_exchanges: filters.swap,
        futures_exchanges: filters.future,
      };
    }

    function getTableBody() {
      const tableContainer = document.getElementById("table-container");
      const table = document.getElementById("spreads-table");
      return table.querySelector("tbody");
    }

    function renderRows(data, amountInUsdt) {
      const tbody = getTableBody();
      data.forEach((item) => {
        const tickerToBuy = `${item.ticker_to_buy.trading_view_name}`;
        const tickerToSell = `${item.ticker_to_sell.trading_view_name}`;
        const link = `/spread_by_symbol_and_exchange?symbol_1=${item.ticker_to_buy.symbol}&exchange_1=${item.ticker_to_buy.exchange_name}&exchange_type_1=${item.ticker_to_buy.market_type}&symbol_2=${item.ticker_to_sell.symbol}&exchange_2=${item.ticker_to_sell.exchange_name}&exchange_type_2=${item.ticker_to_sell.market_type}&amount_in_quote=${amountInUsdt}`;

        const row = document.createElement("tr");
        row.innerHTML = `
      <td>${item.base_currency}</td>
      <td>${item.spread_percent.toFixed(2)}%</td>
      <td>${tickerToBuy}</td>
      <td>${tickerToSell}</td>
      <td><a href="${link}" target="_blank">Open more</a></td>
    `;
        tbody.appendChild(row);
      });
    }

    async function fetchEndpoint(endpoint, body) {
      const response = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      if (!response.ok) throw new Error("Error request");
      return await response.json();
    }

    async function fetchSpreads() {
      const tableContainer = document.getElementById("table-container");
      const filters = getFilters();
      const body = buildRequestBody(filters);
      const endpoint = filters.noTransfer ? "/api/spreads/no-transfer" : "/api/spreads";
      try {
        setLoadingState(true);
        tableContainer.style.display = "none";
        const data = await fetchEndpoint(endpoint, body);
        renderRows(data, filters.amountInUsdt);
        tableContainer.style.display = "block";
      } catch (err) {
        console.error(err);
        alert("Cannot load spread info");
      } finally {
        setLoadingState(false);
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>